AUI.add("aui-scheduler-event-recorder",function(y){var at=y.Lang,G=at.isArray,S=at.isObject,p=at.isString,C=at.isUndefined,ah=y.IO.prototype._serialize,o=y.DataType.DateMath,K="-",E=".",d=" ",R="scheduler-event",ap="scheduler-event-recorder",e="activeView",N="arrow",aa="body",u="bodyContent",n="borderRadius",ai="boundingBox",P="cancel",X="click",t="constrain",T="content",r="date",Z="dateFormat",s="delete",ao="endDate",h="event",k="footerContent",c="form",M="header",ag="isoTime",aq="node",U="offsetHeight",Y="offsetWidth",D="overlay",al="overlayOffset",ar="px",an="recorder",af="rendered",I="region",am="right",W="save",H="scheduler",ae="schedulerChange",q="shadow",ak="startDate",a="strings",f="submit",j="template",Q="title",ad="toolbar",L="top",ac="visibleChange",m=y.getClassName,F=m(R),ab=m(R,Q),x=m(R,an),w=m(H,h,an,D),b=m(H,h,an,D,N),v=m(H,h,an,D,N,L),V=m(H,h,an,D,N,q),O=m(H,h,an,D,aa),J=m(H,h,an,D,T),l=m(H,h,an,D,r),aj=m(H,h,an,D,c),B=m(H,h,an,D,M),z=new y.Template('<div class="',V," ",b,'"></div>','<div class="',b,'"></div>','<input type="hidden" name="startDate" value="{startDate}" />','<input type="hidden" name="endDate" value="{endDate}" />','<div class="',B,'">','<input class="',J,'" name="content" value="{content}" />',"</div>",'<div class="',O,'">','<label class="',l,'">{date}</label>',"</div>"),i='<form class="'+aj+'" id="schedulerEventRecorderForm"></form>';var g=y.Component.create({NAME:ap,ATTRS:{allDay:{value:false},content:{},duration:{value:60},dateFormat:{validator:p,value:"%a, %B %d,"},event:{},eventClass:{valueFn:function(){return y.SchedulerEvent;}},strings:{value:{},setter:function(A){return y.merge({"delete":"Delete","description-hint":"e.g., Dinner at Brian's",cancel:"Cancel",description:"Description",edit:"Edit",save:"Save",when:"When"},A||{});},validator:S},overlay:{validator:S,value:{constrain:true,visible:false,width:300,zIndex:500}},overlayOffset:{value:[15,-38],validator:G},template:{value:z},toolbar:{setter:function(av){var au=this;var A=au.get(a);return y.merge({children:[{handler:y.bind(au._handleSaveEvent,au),label:A[W]},{handler:y.bind(au._handleCancelEvent,au),label:A[P]},{handler:y.bind(au._handleDeleteEvent,au),label:A[s]}]},av||{});},validator:S,value:{}}},EXTENDS:y.SchedulerEvent,prototype:{initializer:function(){var A=this;A.get(aq).addClass(x);A.publish("cancel",{defaultFn:A._defCancelEventFn});A.publish("delete",{defaultFn:A._defDeleteEventFn});A.publish("edit",{defaultFn:A._defEditEventFn});A.publish("save",{defaultFn:A._defSaveEventFn});A.after(ae,A._afterSchedulerChange);A[D]=new y.Overlay(A.get(D));A[ad]=new y.Toolbar(A.get(ad));},getOverlayContentNode:function(){var A=this;var au=A[D].get(ai);return au.one(E+J);},getUpdatedSchedulerEvent:function(av){var A=this,aw=A.get(h),au={silent:!aw},ax=A.serializeForm();if(!aw){aw=A.clone();}aw.set(H,A.get(H),{silent:true});aw.setAttrs(y.merge(ax,av),au);return aw;},_afterSchedulerChange:function(aw){var A=this;var av=aw.newVal;var au=av.get(ai);au.delegate(X,y.bind(A._onClickSchedulerEvent,A),E+F);},_defCancelEventFn:function(au){var A=this;A.get(aq).remove();A.hideOverlay();},_defDeleteEventFn:function(av){var A=this;var au=A.get(H);au.removeEvents(A.get(h));A.hideOverlay();au.syncEventsUI();},_defEditEventFn:function(av){var A=this;var au=A.get(H);A.hideOverlay();au.syncEventsUI();},_defSaveEventFn:function(av){var A=this;var au=A.get(H);au.addEvents(av.newSchedulerEvent);A.hideOverlay();au.syncEventsUI();},_handleCancelEvent:function(au){var A=this;A.fire("cancel");au.preventDefault();},_handleDeleteEvent:function(au){var A=this;A.fire("delete",{schedulerEvent:A.get(h)});au.preventDefault();},_handleSaveEvent:function(av){var A=this,au=A.get(h)?"edit":"save";A.fire(au,{newSchedulerEvent:A.getUpdatedSchedulerEvent()});av.preventDefault();},_onClickSchedulerEvent:function(av){var A=this;var au=av.currentTarget.getData(R);if(au){A.set(h,au,{silent:true});A.showOverlay([av.pageX,av.pageY]);A.get(aq).remove();}},_onOverlayVisibleChange:function(au){var A=this;if(au.newVal){A.populateForm();if(!A.get(h)){var av=A.getOverlayContentNode();if(av){setTimeout(function(){av.selectText();},0);}}}else{A.set(h,null,{silent:true});A.get(aq).remove();}},_onSubmitForm:function(au){var A=this;A._handleSaveEvent(au);},_renderOverlay:function(){var au=this;var A=au.get(a);au[D].render();au[ad].render();var av=au[D].get(ai);av.addClass(w);au[D].set(k,au[ad].get(ai));au[D].on(ac,y.bind(au._onOverlayVisibleChange,au));au.formNode=y.Node.create(i);au[D].set(u,au.formNode);au.formNode.on(f,y.bind(au._onSubmitForm,au));},getFormattedDate:function(){var av=this;var au=av.get(Z);var ax=(av.get(h)||av);var az=ax.get(ao);var ay=ax.get(H);var A=ax.get(ak);var aw=(ay.get(e).get(ag)?o.toIsoTimeString:o.toUsTimeString);return[ax._formatDate(A,au),aw(A),K,aw(az)].join(d);},getTemplateData:function(){var au=this,A=au.get(a),av=au.get(h)||au,aw=av.get(T);if(C(aw)){aw=A["description-hint"];}return{content:aw,date:au.getFormattedDate(),endDate:av.get(ao).getTime(),startDate:av.get(ak).getTime()};},hideOverlay:function(){var A=this;A[D].hide();},populateForm:function(){var A=this;A.formNode.setContent(A.get(j).parse(A.getTemplateData()));},serializeForm:function(){var A=this;return y.QueryString.parse(ah(A.formNode.getDOM()));},showOverlay:function(aJ,az){var aH=this,aB=aJ.concat([]),aA=aH[D],ay=aA.get(ai);if(!aH[D].get(af)){aH._renderOverlay();}aA.show();var aG=ay.all(E+b),aF=aG.item(0),au=aF.get(Y),aC=aF.get(U);aG.removeClass(v);aG.show();aJ[0]-=ay.get(Y)/2;aJ[1]-=(ay.get(U)+(aC/2));var ax=aA.getConstrainedXY(aJ);if(ax[1]!==aJ[1]){aJ[1]=(aB[1]+(aC/2));aG.addClass(v);}aA.set("xy",aJ);aJ=aA.get("xy");var aE={left:aB[0],right:aB[0],top:aB[1],bottom:aB[1]},aw=ay.getStyle(n).replace(ar,"");if(!y.DOM.inRegion(null,ay.get(I),true,aE)){var av=(au/2)-aw,aD=Math.max(aJ[0],aB[0]),aI=aJ[0]+ay.get(Y)-au,A=Math.min(aD,aI);A-=av;aG.setX(A);}else{aG.hide();}}}});y.SchedulerEventRecorder=g;},"@VERSION@",{skinnable:true,requires:["aui-scheduler-base","aui-template","aui-toolbar","io-form","querystring","overlay"]});
