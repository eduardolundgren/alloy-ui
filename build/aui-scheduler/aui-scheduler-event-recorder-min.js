AUI.add("aui-scheduler-event-recorder",function(V){var K=V.Lang,a=K.isArray,v=K.isObject,ak=K.isString,G=K.isUndefined,m=V.IO.prototype._serialize,t=K.toInt,ag=function(ax,aw,A){return Math.min(Math.max(ax,aw),A);},i=V.DataType.DateMath,ar="-",d=".",aq=" ",N="scheduler-event",O="scheduler-event-recorder",z="activeView",c="arrow",Y="body",Q="bodyContent",b="borderRadius",l="boundingBox",P="cancel",ac="click",s="constrain",T="content",aa="date",U="dateFormat",J="delete",W="endDate",ap="event",q="footerContent",S="form",p="header",ab="isoTime",k="node",y="offsetHeight",aj="offsetWidth",g="overlay",B="overlayOffset",L="px",ao="recorder",an="rendered",e="region",f="right",ad="save",F="scheduler",j="schedulerChange",R="shadow",al="startDate",x="strings",am="submit",ae="template",Z="title",E="toolbar",h="top",X="visibleChange",u=V.getClassName,n=u(N),r=u(N,Z),M=u(N,ao),at=u(F,ap,ao,g),o=u(F,ap,ao,g,c),ah=u(F,ap,ao,g,c,h),ai=u(F,ap,ao,g,c,R),H=u(F,ap,ao,g,Y),af=u(F,ap,ao,g,T),I=u(F,ap,ao,g,aa),C=u(F,ap,ao,g,S),au=u(F,ap,ao,g,p),w=new V.Template('<div class="',ai," ",o,'"></div>','<div class="',o,'"></div>','<input type="hidden" name="startDate" value="{startDate}" />','<input type="hidden" name="endDate" value="{endDate}" />','<div class="',au,'">','<input class="',af,'" name="content" value="{content}" />',"</div>",'<div class="',H,'">','<label class="',I,'">{date}</label>',"</div>"),av='<form class="'+C+'" id="schedulerEventRecorderForm"></form>';var D=V.Component.create({NAME:O,ATTRS:{allDay:{value:false},content:{},duration:{value:60},dateFormat:{validator:ak,value:"%a, %B %d,"},event:{},eventClass:{valueFn:function(){return V.SchedulerEvent;}},strings:{value:{},setter:function(A){return V.merge({"delete":"Delete","description-hint":"e.g., Dinner at Brian's",cancel:"Cancel",description:"Description",edit:"Edit",save:"Save",when:"When"},A||{});},validator:v},overlay:{validator:v,value:{constrain:true,visible:false,width:300,zIndex:500}},overlayOffset:{value:[15,-38],validator:a},template:{value:w},toolbar:{setter:function(ax){var aw=this;var A=aw.get(x);return V.merge({children:[{handler:V.bind(aw._handleSaveEvent,aw),label:A[ad]},{handler:V.bind(aw._handleCancelEvent,aw),label:A[P]},{handler:V.bind(aw._handleDeleteEvent,aw),label:A[J]}]},ax||{});},validator:v,value:{}}},EXTENDS:V.SchedulerEvent,prototype:{initializer:function(){var A=this;A.get(k).addClass(M);A.publish("cancel",{defaultFn:A._defCancelEventFn});A.publish("delete",{defaultFn:A._defDeleteEventFn});A.publish("edit",{defaultFn:A._defEditEventFn});A.publish("save",{defaultFn:A._defSaveEventFn});A.after(j,A._afterSchedulerChange);A[g]=new V.Overlay(A.get(g));A[E]=new V.Toolbar(A.get(E));A[g].on(X,V.bind(A._onOverlayVisibleChange,A));},getOverlayContentNode:function(){var A=this;var aw=A[g].get(l);return aw.one(d+af);},getUpdatedSchedulerEvent:function(ax){var A=this,ay=A.get(ap),aw={silent:!ay},az=A.serializeForm();if(!ay){ay=A.clone();}ay.set(F,A.get(F),{silent:true});ay.setAttrs(V.merge(az,ax),aw);return ay;},_afterSchedulerChange:function(ay){var A=this;var ax=ay.newVal;var aw=ax.get(l);aw.delegate(ac,V.bind(A._onClickSchedulerEvent,A),d+n);},_defCancelEventFn:function(aw){var A=this;A.get(k).remove();A.hideOverlay();},_defDeleteEventFn:function(ax){var A=this;var aw=A.get(F);aw.removeEvents(A.get(ap));A.hideOverlay();aw.syncEventsUI();},_defEditEventFn:function(ax){var A=this;var aw=A.get(F);A.hideOverlay();aw.syncEventsUI();},_defSaveEventFn:function(ax){var A=this;var aw=A.get(F);aw.addEvents(ax.newSchedulerEvent);A.hideOverlay();aw.syncEventsUI();},_handleCancelEvent:function(aw){var A=this;A.fire("cancel");aw.preventDefault();},_handleDeleteEvent:function(aw){var A=this;A.fire("delete",{schedulerEvent:A.get(ap)});aw.preventDefault();},_handleSaveEvent:function(ax){var A=this,aw=A.get(ap)?"edit":"save";A.fire(aw,{newSchedulerEvent:A.getUpdatedSchedulerEvent()});ax.preventDefault();},_onClickSchedulerEvent:function(ax){var A=this;var aw=ax.currentTarget.getData(N);if(aw){A.set(ap,aw,{silent:true});A.showOverlay([ax.pageX,ax.pageY]);A.get(k).remove();}},_onOverlayVisibleChange:function(aw){var A=this;if(aw.newVal){A.populateForm();if(!A.get(ap)){var ax=A.getOverlayContentNode();if(ax){setTimeout(function(){ax.selectText();},0);}}}else{A.set(ap,null,{silent:true});A.get(k).remove();}},_onSubmitForm:function(aw){var A=this;A._handleSaveEvent(aw);},_renderOverlay:function(){var aw=this;var A=aw.get(x);aw[g].render();aw[E].render();var ax=aw[g].get(l);ax.addClass(at);aw[g].set(q,aw[E].get(l));aw.formNode=V.Node.create(av);aw[g].set(Q,aw.formNode);aw.formNode.on(am,V.bind(aw._onSubmitForm,aw));},getFormattedDate:function(){var ax=this;var aw=ax.get(U);var az=(ax.get(ap)||ax);var aB=az.get(W);var aA=az.get(F);var A=az.get(al);var ay=(aA.get(z).get(ab)?i.toIsoTimeString:i.toUsTimeString);return[az._formatDate(A,aw),ay(A),ar,ay(aB)].join(aq);},getTemplateData:function(){var aw=this,A=aw.get(x),ax=aw.get(ap)||aw,ay=ax.get(T);if(G(ay)){ay=A["description-hint"];}return{content:ay,date:aw.getFormattedDate(),endDate:ax.get(W).getTime(),startDate:ax.get(al).getTime()};},hideOverlay:function(){var A=this;A[g].hide();},populateForm:function(){var A=this;A.formNode.setContent(A.get(ae).parse(A.getTemplateData()));},serializeForm:function(){var A=this;return V.QueryString.parse(m(A.formNode.getDOM()));},showOverlay:function(aF){var aE=this,aB=aF.concat([]),aC=aE[g],aA=aC.get(l);if(!aE[g].get(an)){aE._renderOverlay();}aC.show();var aD=aA.all(d+o),az=aD.item(0),aw=az.get(y),ay=az.get(aj);aD.removeClass(ah).show();aF[0]-=aA.get(aj)*0.5;aF[1]-=aA.get(y)+aw*0.5;var ax=aC.getConstrainedXY(aF);if(ax[1]!==aF[1]){aF[1]=aB[1]+aw*0.5;aD.addClass(ah);}aF=aC.getConstrainedXY(aF);aC.set("xy",aF);var A=ag(aB[0]-ay*0.5,aF[0],aF[0]+aA.get(aj));aD.setX(A);}}});V.SchedulerEventRecorder=D;},"@VERSION@",{skinnable:true,requires:["aui-scheduler-base","aui-template","aui-toolbar","io-form","querystring","overlay"]});