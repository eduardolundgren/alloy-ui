<!DOCTYPE html>

<html>
<head>
    <link rel="stylesheet" href="../../build/aui-css/css/bootstrap.css">
</head>
<style type="text/css" media="screen">
    body {
        font-size: 12px;
    }

    .wrapper {
        padding: 10px;
    }

    .toolbar {
        margin-bottom: 1em;
    }

    .bookshelf {
        background-image: url('assets/bookshelf.png');
        border: 2px solid #BBB;
        height: 960px;
        position: relative;
        width: 640px;
    }

    .img-container {
        bottom: 0;
        left: 50%;
        display: block;
        position: absolute;
    }
</style>
<body>

<div class="wrapper">
    <h1>Synchronous Undo/Redo demo</h1>

    <div class="toolbar">
        <button class="btn btn-primary btn-large" id="addBook">Add book</button>
        <button class="btn btn-large" disabled id="undo">Undo</button>
        <button class="btn btn-large" disabled id="redo">Redo</button>
    </div>

    <div class="bookshelf"></div>
</div>

<script src="../../build/aui/aui.js"></script>

<script type="text/javascript" charset="utf-8">
YUI({
    combine: false,
    filter: 'raw'
}).ready('aui-undo-redo', 'node-base', function(A) {
    'use strict';

    var Lang = A.Lang,
        Node = A.Node,

        actions,
        AddBookAction,
        addBookBtn,
        bookshelfNode,
        booksRowIndex,
        bookWidth,
        curRow,
        left,
        maxBooksShelf,
        offsetHeigth,
        redoBtn,
        startHeight,
        tplImg,
        undoBtn,
        undoRedo;

    booksRowIndex = 0;
    bookWidth = 55;
    curRow = 0;
    left = 20;
    maxBooksShelf = 11;
    offsetHeigth = 175;
    startHeight = 220;

    function addBook() {
        var actions,
            addBookAction,
            curIndex,
            img;

        curIndex = undoRedo.get('undoIndex');

        img = Node.create(
            Lang.sub(
                tplImg,
                {
                    bottom: startHeight + (curRow * offsetHeigth),
                    left: left + (booksRowIndex * bookWidth),
                    index: curIndex
                }
            )
        );

        bookshelfNode.appendChild(img);

        addBookAction = new AddBookAction({
            booksRowIndex: booksRowIndex,
            curRow: curRow,
            imgIndex: curIndex
        });

        if (++booksRowIndex === maxBooksShelf) {
            booksRowIndex = 0;

            ++curRow;
        }

        if (curRow === 4) {
            addBookBtn.setAttribute('disabled', true);
        }

        undoRedo.add(addBookAction);
    }

    function removeBook(index) {
        var imgNode = bookshelfNode.one('[data-index="' + index + '"]');

        if (imgNode) {
            bookshelfNode.removeChild(imgNode.ancestor());
        }
    }

    function updateUI(){
        var options, undoIndex;

        undoRedo.canUndo() ?
            undoBtn.removeAttribute('disabled') :
            undoBtn.setAttribute('disabled', true);

        undoRedo.canRedo() ?
            redoBtn.removeAttribute('disabled') :
            redoBtn.setAttribute('disabled', true );
    }

    tplImg =
        '<div class="img-container" style="left: {left}px; bottom: {bottom}px">' +
            '<img data-index="{index}" src="assets/book.jpg">' +
        '</div>';

    // Main entry

    undoRedo = new A.UndoRedo();

    undoRedo.subscribe('actionAdded', updateUI);
    undoRedo.subscribe('actionCanceled', updateUI);
    undoRedo.subscribe('redoFinished', updateUI);
    undoRedo.subscribe('undoFinished', updateUI);

    AddBookAction = A.Base.create('addbookaction', A.UndoRedoAction, [], {
        redo: addBook,

        undo: function() {
            var instance = this,
                imgIndex;

            if (curRow === 4) {
                addBookBtn.removeAttribute('disabled');
            }

            imgIndex = instance.get('imgIndex');

            removeBook(imgIndex);

            curRow = instance.get('curRow');

            booksRowIndex = instance.get('booksRowIndex');
        }
    }, {
        ATTRS: {
            booksRowIndex: {
                validator: Lang.isNumber
            },
            curRow: {
                validator: Lang.isNumber
            },
            imgIndex: {
                validator: Lang.isNumber
            }
        }
    });

    bookshelfNode = A.one('.bookshelf');

    addBookBtn = A.one('#addBook');

    addBookBtn.on('click', addBook);


    undoBtn = A.one('#undo');

    undoBtn.on('click', function() {
        undoRedo.undo();
    });

    redoBtn = A.one('#redo');

    redoBtn.on('click', function() {
        undoRedo.redo();
    });
});
</script>

</body>
</html>